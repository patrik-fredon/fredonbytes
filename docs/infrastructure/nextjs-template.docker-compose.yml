# =============================================================================
# NEXT.JS APPLICATION TEMPLATE
# =============================================================================
# Copy this to your Next.js project root as docker-compose.yml
# Customize container name, domains, and Redis DB number
# =============================================================================

services:
  app:
    container_name: YOUR-APP-NAME  # Change this! (e.g., fredonbytes-app)
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped

    environment:
      # Core
      - NODE_ENV=production
      - REDIS_URL=redis://redis-shared:6379/0  # Change DB number per project!
      - CSRF_SECRET=${CSRF_SECRET:?}
      - BEHIND_PROXY=true

      # Domains
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL:?}
      - NEXT_PUBLIC_PRIMARY_DOMAIN=${NEXT_PUBLIC_PRIMARY_DOMAIN:?}
      - NEXT_PUBLIC_SECONDARY_DOMAINS=${NEXT_PUBLIC_SECONDARY_DOMAINS:-}

      # Email
      - NEXT_PUBLIC_SUPPORT_EMAIL=${NEXT_PUBLIC_SUPPORT_EMAIL:?}
      - NEXT_PUBLIC_CONTACT_EMAIL=${NEXT_PUBLIC_CONTACT_EMAIL:?}
      - SMTP_HOST=${SMTP_HOST:?}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:?}
      - SMTP_PASS=${SMTP_PASS:?}

      # Database (Supabase)
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:?}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:?}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:?}

    networks:
      - web

    labels:
      # Traefik Routing - CUSTOMIZE THESE!
      - "traefik.enable=true"
      - "traefik.http.routers.YOUR-ROUTER-NAME.rule=Host(`your-domain.com`) || Host(`www.your-domain.com`)"
      - "traefik.http.routers.YOUR-ROUTER-NAME.entrypoints=web"
      - "traefik.http.services.YOUR-SERVICE-NAME.loadbalancer.server.port=3000"

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  web:
    external: true
    name: web

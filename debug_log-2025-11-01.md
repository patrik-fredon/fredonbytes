# PWA Route Testing Debug Log
**Date**: November 1, 2025  
**Testing Tools**: Chrome DevTools + Playwright MCP

## Critical Issues

### 1. CSRF Blocking POST Requests
- **Location**: `src/middleware.ts`
- **Cause**: CSRF middleware requires valid token for state-changing requests; `/api/share` and `/api/open-file` not exempt
- **Impact**: POST to PWA share/file endpoints returned 403 Forbidden
- **Fix Applied**: Added `/api/share` and `/api/open-file` to `csrfExemptPaths` array
- **Status**: ✅ Fixed

## High Priority Issues

### 1. Manifest Protocol Handler URL Mismatch
- **Location**: `src/app/manifest.json` + `src/app/api/handle-protocol/route.ts`
- **Cause**: Manifest pointed to `/handle-protocol?data=%s` while server route at `/api/handle-protocol`
- **Impact**: Protocol handler invocations resulted in 404
- **Fix Applied**: Changed manifest entry to `/api/handle-protocol?data=%s`
- **Status**: ✅ Fixed

### 2. Rate Limiting Blocking PWA Endpoints
- **Location**: `src/middleware.ts` (rate limiter)
- **Cause**: Global per-IP limit applied to all API routes including PWA endpoints
- **Impact**: Rapid requests could receive 429 Too Many Requests
- **Fix Applied**: Whitelisted `/api/share`, `/api/open-file`, `/api/handle-protocol` from rate limiting
- **Status**: ✅ Fixed

## Medium Priority Issues

### 1. Missing CSRF Token Acquisition Endpoint
- **Location**: Missing public CSRF endpoint
- **Cause**: Middleware sets token on `NextResponse.next()` but no GET endpoint available
- **Impact**: Client couldn't obtain CSRF token for double-submit pattern
- **Fix Applied**: Created `src/app/api/csrf/route.ts` GET endpoint
- **Status**: ✅ Fixed

### 2. Redirects Missing Locale Prefix
- **Location**: `src/app/api/share/route.ts`, `open-file/route.ts`, `handle-protocol/route.ts`
- **Cause**: Routes built absolute paths like `/contact` without current locale
- **Impact**: Redirects could 404 on localized site (e.g., `/en/contact`)
- **Fix Applied**: Extract locale from request pathname and include in redirect URLs
- **Status**: ✅ Fixed

## Low Priority Issues

### 1. Debug Console Logging in Production
- **Location**: All `src/app/api/*` routes
- **Cause**: Development `console.log` used in production code
- **Recommendation**: Replace with structured logger, respect log levels
- **Status**: ⚠️ Deferred to follow-up

### 2. Redundant Mailto Handler
- **Location**: `src/app/manifest.json`
- **Cause**: Browsers handle `mailto:` links natively
- **Recommendation**: Remove or keep intentionally for custom in-app handler
- **Status**: ⚠️ Deferred to follow-up

---

## Test Results

### ✅ Passing Tests
- Manifest served correctly at `/manifest.json`
- Icons accessible: `/web-app-manifest-192x192.png`, `/web-app-manifest-512x512.png`
- Protocol handler works with corrected URL
- CSRF token endpoint responds correctly

### ❌ Fixed Issues
- POST `/api/share` without CSRF token: ~~403~~ → 302 redirect ✅
- POST `/api/open-file` without CSRF token: ~~403~~ → 302 redirect ✅
- Protocol handler URL mismatch: ~~404~~ → 200/302 ✅
- Rate limiter blocking PWA endpoints: ~~429~~ → whitelisted ✅
- Missing locale in redirects: ~~404~~ → locale-aware ✅

---

## Files Modified

1. `src/middleware.ts`
   - Added `/api/share`, `/api/open-file` to `csrfExemptPaths`
   - Whitelisted PWA endpoints from rate limiting

2. `src/app/manifest.json`
   - Changed `web+fredonbytes` protocol URL to `/api/handle-protocol?data=%s`

3. `src/app/api/csrf/route.ts` (NEW)
   - Created GET endpoint for CSRF token acquisition

4. `src/app/api/share/route.ts`
   - Extract locale from request pathname
   - Build redirect URLs with locale prefix: `/${locale}/contact`

5. `src/app/api/open-file/route.ts`
   - Extract locale from request pathname
   - Build redirect URLs with locale prefix: `/${locale}/projects`

6. `src/app/api/handle-protocol/route.ts`
   - Extract locale from request pathname
   - Build redirect URLs with locale prefix for all protocol types

---

## Next Steps

### Immediate (Testing)
- [ ] Re-run Playwright checks to validate fixes
- [ ] Test POST to `/api/share` with FormData
- [ ] Test POST to `/api/open-file` with files
- [ ] Test GET `/api/handle-protocol` with `mailto:` and `web+fredonbytes:`
- [ ] Verify CSRF token set by GET `/api/csrf`

### Follow-up (Hardening)
- [ ] Implement proper CSRF double-submit flow for PWA (signed tokens)
- [ ] Persistent rate-limiter store (Redis/Upstash) for production
- [ ] Replace `console.log` with structured logger
- [ ] Add integration tests for PWA endpoints
- [ ] Document PWA setup in `PWA_MANIFEST_README.md`

---

## Reproduction Steps (Pre-Fix)

1. Open `http://localhost:3000/en` in Chrome DevTools
2. Execute: `fetch('/api/share', {method: 'POST', body: new FormData()})` → ❌ 403 Forbidden
3. Check manifest at `/manifest.json` → protocol handler points to `/handle-protocol` (not `/api/handle-protocol`)
4. Execute: `fetch('/api/handle-protocol?data=web+fredonbytes:test')` → worked (API route exists)
5. Execute: `fetch('/handle-protocol?data=web+fredonbytes:test')` → ❌ 404 (manifest URL wrong)
6. Rapidly call endpoints → potential ❌ 429 Too Many Requests

## Quick Test Commands

```bash
# Test CSRF endpoint
curl -i http://localhost:3000/api/csrf

# Test share endpoint (without CSRF - should redirect)
curl -i -X POST http://localhost:3000/api/share \
  -F "title=Test" \
  -F "text=Hello World"

# Test protocol handler
curl -i "http://localhost:3000/api/handle-protocol?data=web+fredonbytes:test-action"

# Verify manifest
curl -s http://localhost:3000/manifest.json | jq '.protocol_handlers'
```

# =============================================================================
# FREDONBYTES - MAIN APPLICATION
# =============================================================================
# Next.js application with Traefik routing
# Uses shared Redis from ~/infrastructure setup
#
# Stack: Lightweight Production Setup
# - Traefik: Reverse proxy (from infrastructure)
# - Redis DB 0: Shared cache (from infrastructure)
#
# Domains: fredonbytes.eu, .com, .tech, .cloud, .cz
# =============================================================================

services:
  app:
    container_name: fredonbytes-app
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      # Node.js & Application
      - NODE_ENV=production
      - REDIS_URL=redis://default:6tduI6zFoFy66NBJGQowTUiG4XEYbUKol5ZCZ7Sm0fo=@redis:6379/0
      - CSRF_SECRET=${CSRF_SECRET:?}

      # Multi-Domain Configuration
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL:?}
      - NEXT_PUBLIC_PRIMARY_DOMAIN=${NEXT_PUBLIC_PRIMARY_DOMAIN:?}
      - NEXT_PUBLIC_SECONDARY_DOMAINS=${NEXT_PUBLIC_SECONDARY_DOMAINS:-}
      - NEXT_PUBLIC_DOMAIN_STRATEGY=${NEXT_PUBLIC_DOMAIN_STRATEGY:-primary}
      - BEHIND_PROXY=${BEHIND_PROXY:-true}

      # Email Configuration (Domain-Aware)
      - NEXT_PUBLIC_SUPPORT_EMAIL=${NEXT_PUBLIC_SUPPORT_EMAIL:?}
      - NEXT_PUBLIC_CONTACT_EMAIL=${NEXT_PUBLIC_CONTACT_EMAIL:?}

      # SMTP Configuration (Nodemailer)
      - SMTP_HOST=${SMTP_HOST:-smtp.forpsi.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - SMTP_USER=${SMTP_USER:?}
      - SMTP_PASS=${SMTP_PASS:?}
      - SMTP_REJECT_UNAUTHORIZED=${SMTP_REJECT_UNAUTHORIZED:-true}

      # Database (Supabase)
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:?}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:?}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:?}

      # SEO Verification (Optional)
      - NEXT_PUBLIC_GOOGLE_VERIFICATION=${NEXT_PUBLIC_GOOGLE_VERIFICATION:-}
      - NEXT_PUBLIC_BING_VERIFICATION=${NEXT_PUBLIC_BING_VERIFICATION:-}

    networks:
      - web
      - backend
    labels:
      # Traefik Routing
      - "traefik.enable=true"
      - "traefik.http.routers.fredonbytes-main.rule=Host(`fredonbytes.eu`) || Host(`fredonbytes.com`) || Host(`fredonbytes.tech`) || Host(`fredonbytes.cloud`) || Host(`fredonbytes.cz`)"
      - "traefik.http.routers.fredonbytes-main.entrypoints=web"
      - "traefik.http.services.fredonbytes-main.loadbalancer.server.port=3000"

    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  web:
    external: true
    name: web
  backend:
    external: true
    name: backend

# =============================================================================
# FREDONBYTES - DOCKER COMPOSE FOR COOLIFY
# =============================================================================
#
# This docker-compose file is optimized for Coolify hosting platform.
# https://coolify.io/docs/knowledge-base/docker/compose
#
# DEPLOYMENT STEPS:
#
# 1. Create a new service in Coolify with type "Docker Compose"
# 2. Copy this docker-compose.yml content to Coolify
# 3. Configure environment variables in Coolify UI:
#    - Required variables (marked with :?) will show with red border
#    - Optional variables (marked with :-) have default values
# 4. Set primary domain in Coolify for your app service
# 5. Deploy!
#
# ENVIRONMENT VARIABLES:
# All environment variables are auto-detected by Coolify UI.
# See .env.example for detailed documentation of each variable.
#
# NETWORKING:
# - Port 3000 is exposed for local development/testing
# - In Coolify, traffic is routed via Traefik proxy (labels configured)
# - Redis is internal-only (traefik.enable=false)
# - Multi-domain support: All domains (primary + secondary) are accepted by Traefik
# - Application middleware handles 301 redirects from secondary to primary domain
# - Compatible with Cloudflare tunnel routing all domains to localhost:3000
#
# VOLUMES:
# - redis-data: Persistent Redis storage (managed by Coolify)
#
# HEALTH CHECKS:
# - App: HTTP check on /api/health endpoint
# - Redis: Redis CLI ping command
#
# =============================================================================

services:
  app:
    container_name: fredonbytes-app
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      # Node.js & Application
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
      - CSRF_SECRET=${CSRF_SECRET:?}

      # Multi-Domain Configuration
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL:?}
      - NEXT_PUBLIC_PRIMARY_DOMAIN=${NEXT_PUBLIC_PRIMARY_DOMAIN:?}
      - NEXT_PUBLIC_SECONDARY_DOMAINS=${NEXT_PUBLIC_SECONDARY_DOMAINS:-}
      - NEXT_PUBLIC_DOMAIN_STRATEGY=${NEXT_PUBLIC_DOMAIN_STRATEGY:-primary}
      - BEHIND_PROXY=${BEHIND_PROXY:-true}

      # Email Configuration (Domain-Aware)
      - NEXT_PUBLIC_SUPPORT_EMAIL=${NEXT_PUBLIC_SUPPORT_EMAIL:?}
      - NEXT_PUBLIC_CONTACT_EMAIL=${NEXT_PUBLIC_CONTACT_EMAIL:?}

      # SMTP Configuration (Nodemailer)
      - SMTP_HOST=${SMTP_HOST:-smtp.forpsi.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - SMTP_USER=${SMTP_USER:?}
      - SMTP_PASS=${SMTP_PASS:?}
      - SMTP_REJECT_UNAUTHORIZED=${SMTP_REJECT_UNAUTHORIZED:-true}

      # Database (Supabase)
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:?}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:?}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:?}

      # SEO Verification (Optional)
      - NEXT_PUBLIC_GOOGLE_VERIFICATION=${NEXT_PUBLIC_GOOGLE_VERIFICATION:-}
      - NEXT_PUBLIC_BING_VERIFICATION=${NEXT_PUBLIC_BING_VERIFICATION:-}

    labels:
      # Coolify Management Labels
      - "coolify.managed=true"
      # Traefik Routing (for Coolify proxy integration)
      # MULTI-DOMAIN SUPPORT: Accept all configured domains (primary + secondary)
      # The middleware will handle 301 redirects from secondary to primary domain
      - "traefik.enable=true"
      - "traefik.http.routers.fredonbytes.rule=Host(`${NEXT_PUBLIC_PRIMARY_DOMAIN:?}`) || Host(`fredonbytes.cloud`) || Host(`fredonbytes.com`) || Host(`fredonbytes.eu`) || Host(`fredonbytes.tech`)"
      - "traefik.http.routers.fredonbytes.entrypoints=websecure"
      - "traefik.http.routers.fredonbytes.tls=true"
      - "traefik.http.routers.fredonbytes.tls.certresolver=letsencrypt"
      - "traefik.http.services.fredonbytes.loadbalancer.server.port=3000"

    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  redis:
    container_name: fredonbytes-redis
    image: redis:7-alpine
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    restart: unless-stopped
    labels:
      # Coolify Management Labels
      - "coolify.managed=true"
      # Exclude from public exposure (internal service only)
      - "traefik.enable=false"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis-insight:
    container_name: fredonbytes-redis-insight
    image: redis/redisinsight:latest
    ports:
      - "5487:5540"
    volumes:
      - redis-insight-data:/data
    environment:
      - REDIS_HOSTS=local:redis:6379
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    labels:
      # Coolify Management Labels
      - "coolify.managed=true"
      # Traefik routing for Redis Insight (optional - only if you want web access)
      # Uncomment the lines below if you want to expose Redis Insight via subdomain
      # - "traefik.enable=true"
      # - "traefik.http.routers.redis-insight.rule=Host(`redis.${NEXT_PUBLIC_PRIMARY_DOMAIN:?}`)"
      # - "traefik.http.routers.redis-insight.entrypoints=websecure"
      # - "traefik.http.routers.redis-insight.tls=true"
      # - "traefik.http.routers.redis-insight.tls.certresolver=letsencrypt"
      # - "traefik.http.services.redis-insight.loadbalancer.server.port=5540"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5540/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

volumes:
  redis-data:
    driver: local
  redis-insight-data:
    driver: local
